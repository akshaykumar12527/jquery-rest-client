(function(e){e.RestClient=function(g,d){"object"==typeof g?d={api:g}:"object"==typeof d?d.api=g:d={api:g};var c=e.extend({waitingTime:300,waitLoopLimit:60,logger:0,fnError:function(b){},setup:{dataType:"json",headers:{}}},d||{}),f=function(b){1>=c.logger&&console.log("jQuery-Rest-Client: "+b)},n=function(b){2>=c.logger&&console.error("jQuery-Rest-Client: "+b);c.fnError(b)},h={},k=null,p=0,l=function(b,d){var a=-1<b.parent&&b.waiting?b.waiting:k;if(a&&!h[a])if(f("Trying... "+b.key),b.waitingCount<
c.waitLoopLimit)setTimeout(function(){++b.waitingCount;l(b,d)},c.waitingTime);else return n("Wait too long, canceled operation. ["+b.key+":"+b.section+"]");else return a=e.extend({method:b.current.method,url:c.api+"/"+b.url+b.current.path,success:d,cache:c.cache,headers:b.current.headers},c.setup||{}),"POST"==b.current.method?a.data=b.current.data:"GET"==b.current.method&&(a.data=e.extend(b.current.query||{},b.current.data||{})),e.ajax(a)},m=function(b,d){this.waitingCount=0;this.section=b;this.url=
d;this.parent=-1;this.waiting=null;this.key=p++;this.current=this.currentClean={method:null,query:null,data:null,path:"",headers:{}};this.childrens=[];this.wait=function(a){if(!0===h[a])return this;h[a]=!1;-1<this.parent?(f("WAIT REGISTRY IN PARENT: "+a+" by "+this.key),this.waiting=a):(f("WAIT REGISTRY WHIOUT PARENT: "+a+" by "+this.key),k=a);return this};this.release=function(a){h[a]=!0;f("WAIT UNREGISTRED: "+a+" by "+this.key);return this};this.setApi=function(a){c.api=d=a;return this};this.add=
function(a,b){this.childrens.push(a);this[a]=new m(a,b||a);this[a].parent=this.key};this.query=function(a){this.current.query=a;return this};this.data=function(a){this.current.data=a;return this};this.defaultHeaders=function(a){c.setup.headers=e.extend(c.setup.headers,a||{});return this};this.headers=function(a){this.current.headers=e.extend(this.current.headers,a||{});return this};this.token=function(a,b){this.defaultHeaders({"x-access-token":a,"x-key":b})};this.clear=function(a){a?current=currentClean:
(this.current.query=null,this.current.data=null,this.current.method=null,this.current.path="")};this.error=function(a){c.fnError=a};this.read=function(a){this.clear();"object"==typeof a?(this.current.query=a,this.current.path=""):this.current.path="/"+a;this.current.method="GET";return this};this.create=function(a){this.clear();this.current.data=a;this.current.method="POST";return this};this.update=function(a){this.clear();this.current.data=a;this.current.method="PUT";return this};this["delete"]=
function(a){this.clear();this.current.path="/"+a;this.current.method="DELETE";return this};this.custom=function(a){this.current={method:a.method||null,query:a.query||null,data:a.query||null,path:a.path||"",headers:a.headers||{}};return this};this.get=this.read;this.insert=this.post=this.create;this.remove=this.del=this["delete"];this.then=function(a){f("Run the "+this.key);return l(this,a)};return this};return m(c.api)}})(jQuery);
